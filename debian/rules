#!/usr/bin/make -f
# -*- makefile -*-
include $(DISTRIBUTION_REFROOT)/opt/bb/share/gcc-build-base/gcc-build-base.mk

PREFIX  ?= /opt/bb
TMPDIR  ?= /tmp
LLVMDIR ?= $(DISTRIBUTION_REFROOT)$(LIBDIR_32BIT)/llvm-5.0
CLANG   ?= $(DISTRIBUTION_REFROOT)$(LIBDIR_32BIT)/llvm-5.0/bin/clang++

build: build-arch

build-arch: debian/build-stamp

binary: binary-arch

binary-arch: debian/binary-stamp

debian/build-stamp:
	+$(MAKE)
	touch $@

debian/install-bin-stamp: debian/build-stamp
	$(MAKE) DESTDIR=$(abspath debian/tmp/bin$(PREFIX)) install-bin
	touch $@

debian/install-dev-stamp: debian/build-stamp
	$(MAKE) DESTDIR=$(abspath debian/tmp/dev$(PREFIX)) install-dev
	touch $@

debian/install-stamp: debian/install-bin-stamp debian/install-dev-stamp
	touch $@

debian/binary-bin-stamp: debian/install-bin-stamp
	mkdir -p debian/tmp/bin/DEBIAN
	dpkg-gencontrol -pbde-verify -Pdebian/tmp/bin
	dpkg-deb -b debian/tmp/bin $(TMPDIR)
	touch $@

debian/binary-dev-stamp: debian/install-dev-stamp
	mkdir -p debian/tmp/dev/DEBIAN
	dpkg-gencontrol -plibbde-verify-dev -Pdebian/tmp/dev
	dpkg-deb -b debian/tmp/dev $(TMPDIR)
	touch $@

debian/binary-stamp: debian/binary-bin-stamp debian/binary-dev-stamp
	touch $@

.EXPORT_ALL_VARIABLES:

clean:
	rm -rf debian/tmp                                                         \
           debian/files                                                       \
           debian/build-stamp                                                 \
           debian/install-bin-stamp                                           \
           debian/install-dev-stamp                                           \
           debian/install-stamp                                               \
           debian/binary-bin-stamp                                            \
           debian/binary-dev-stamp                                            \
           debian/binary-stamp

.PHONY: clean build build-arch binary binary-arch
